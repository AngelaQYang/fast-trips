

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>fasttrips.Assignment &mdash; fasttrips 1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="fasttrips 1.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="../../index.html" class="icon icon-home"> fasttrips
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Assignment.html">fasttrips.Assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.FastTrips.html">fasttrips.FastTrips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Passenger.html">fasttrips.Passenger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Path.html">fasttrips.Path</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Route.html">fasttrips.Route</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Stop.html">fasttrips.Stop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.TAZ.html">fasttrips.TAZ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_generated/fasttrips.Trip.html">fasttrips.Trip</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../fasttrips_c_extension.html">fasttrips C++ Extension</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">fasttrips</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>fasttrips.Assignment</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for fasttrips.Assignment</h1><div class="highlight"><pre>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s">&quot;Copyright 2015 Contributing Entities&quot;</span>
<span class="n">__license__</span>   <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s">    you may not use this file except in compliance with the License.</span>
<span class="s">    You may obtain a copy of the License at</span>

<span class="s">        http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="s">    Unless required by applicable law or agreed to in writing, software</span>
<span class="s">    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s">    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s">    See the License for the specific language governing permissions and</span>
<span class="s">    limitations under the License.</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">collections</span><span class="o">,</span><span class="nn">datetime</span><span class="o">,</span><span class="nn">math</span><span class="o">,</span><span class="nn">multiprocessing</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">random</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">numpy</span><span class="o">,</span><span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">_fasttrips</span>

<span class="kn">from</span> <span class="nn">.Logger</span> <span class="kn">import</span> <span class="n">FastTripsLogger</span><span class="p">,</span> <span class="n">setupLogging</span>
<span class="kn">from</span> <span class="nn">.Passenger</span> <span class="kn">import</span> <span class="n">Passenger</span>
<span class="kn">from</span> <span class="nn">.Path</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">.Stop</span> <span class="kn">import</span> <span class="n">Stop</span>
<span class="kn">from</span> <span class="nn">.TAZ</span> <span class="kn">import</span> <span class="n">TAZ</span>
<span class="kn">from</span> <span class="nn">.Trip</span> <span class="kn">import</span> <span class="n">Trip</span>

<div class="viewcode-block" id="Assignment"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment">[docs]</a><span class="k">class</span> <span class="nc">Assignment</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assignment class.  Documentation forthcoming.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">#: Configuration: Maximum number of iterations to remove capacity violations. When</span>
    <span class="c">#: the transit system is not crowded or when capacity constraint is</span>
    <span class="c">#: relaxed the model will terminate after the first iteration</span>
    <span class="n">ITERATION_FLAG</span>                  <span class="o">=</span> <span class="mi">1</span>

    <span class="n">ASSIGNMENT_TYPE_SIM_ONLY</span>        <span class="o">=</span> <span class="s">&#39;Simulation Only&#39;</span>
    <span class="n">ASSIGNMENT_TYPE_DET_ASGN</span>        <span class="o">=</span> <span class="s">&#39;Deterministic Assignment&#39;</span>
    <span class="n">ASSIGNMENT_TYPE_STO_ASGN</span>        <span class="o">=</span> <span class="s">&#39;Stochastic Assignment&#39;</span>
    <span class="c">#: Configuration: Assignment Type</span>
    <span class="c">#: &#39;Simulation Only&#39; - No Assignment (only simulation, given paths in the input)</span>
    <span class="c">#: &#39;Deterministic Assignment&#39;</span>
    <span class="c">#: &#39;Stochastic Assignment&#39;</span>
    <span class="n">ASSIGNMENT_TYPE</span>                 <span class="o">=</span> <span class="n">ASSIGNMENT_TYPE_DET_ASGN</span>

    <span class="c">#: Configuration: Simulation flag. It should be on for iterative assignment. In a one shot</span>
    <span class="c">#: assignment with simulation flag off, the passengers are assigned to</span>
    <span class="c">#: paths but are not loaded to the network.</span>
    <span class="n">SIMULATION_FLAG</span>                 <span class="o">=</span> <span class="bp">True</span>

    <span class="c">#: Configuration: Passenger trajectory output flag. Passengers&#39; path and time will be</span>
    <span class="c">#: reported if this flag is on. Note that the simulation flag should be on for</span>
    <span class="c">#: passengers&#39; time.</span>
    <span class="n">OUTPUT_PASSENGER_TRAJECTORIES</span>   <span class="o">=</span> <span class="bp">True</span>

    <span class="c">#: Configuration: Path time-window. This is the time in which the paths are generated.</span>
    <span class="c">#: E.g. with a typical 30 min window, any path within 30 min of the</span>
    <span class="c">#: departure time will be checked.</span>
    <span class="n">PATH_TIME_WINDOW</span>                <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>

    <span class="c">#: Configuration: Create skims flag. This is specific to the travel demand models</span>
    <span class="c">#: (not working in this version)</span>
    <span class="n">CREATE_SKIMS</span>                    <span class="o">=</span> <span class="bp">False</span>

    <span class="c">#: Configuration: Beginning of the time period for which the skim is required.</span>
    <span class="c">#: (in minutes from start of day)</span>
    <span class="n">SKIM_START_TIME</span>                 <span class="o">=</span> <span class="mi">300</span>

    <span class="c">#: Configuration: End of the time period for which the skim is required</span>
    <span class="c">#: (minutes from start of day)</span>
    <span class="n">SKIM_END_TIME</span>                   <span class="o">=</span> <span class="mi">600</span>

    <span class="c">#: Route choice configuration: Dispersion parameter in the logit function.</span>
    <span class="c">#: Higher values result in less stochasticity. Must be nonnegative. </span>
    <span class="c">#: If unknown use a value between 0.5 and 1</span>
    <span class="n">DISPERSION_PARAMETER</span>            <span class="o">=</span> <span class="mf">1.0</span>

    <span class="c">#: Route choice configuration: Use vehicle capacity constraints</span>
    <span class="n">CAPACITY_CONSTRAINT</span>             <span class="o">=</span> <span class="bp">False</span>

    <span class="c">#: Use this as the date</span>
    <span class="n">TODAY</span>                           <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>

    <span class="c">#: Trace these passengers</span>
    <span class="n">TRACE_PASSENGER_IDS</span>             <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="mi">215</span><span class="p">]</span>

    <span class="c">#: Number of processes to use for path finding (via :py:mod:`multiprocessing`)</span>
    <span class="c">#: Set to 1 to run everything in this process</span>
    <span class="c">#: Set to less than 1 to use the result of :py:func:`multiprocessing.cpu_count`</span>
    <span class="c">#: Set to positive integer greater than 1 to set a fixed number of processes</span>
    <span class="n">NUMBER_OF_PROCESSES</span>             <span class="o">=</span> <span class="mi">14</span>

    <span class="c">#: Extra time so passengers don&#39;t get bumped (?)</span>
    <span class="n">BUMP_BUFFER</span>                     <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>

    <span class="c">#: This is the only simulation state that exists across iterations</span>
    <span class="c">#: It&#39;s a dictionary of (trip_id, stop_id) -&gt; earliest time a bumped passenger started waiting</span>
    <span class="n">bump_wait</span>                       <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bump_wait_df</span>                    <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: This is a :py:class:`set` of bumped passenger IDs.  For multiple-iteration assignment,</span>
    <span class="c">#: this determines which passengers to assign.</span>
    <span class="n">bumped_passenger_ids</span>            <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">bumped_path_ids</span>                 <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c">#: Simulation: bump one stop at a time (slower, more accurate)</span>
    <span class="c">#:</span>
    <span class="c">#: When addressing capacity constraints in simulation, we look at all the (trip, stop)-pairs</span>
    <span class="c">#: where the boards are not allowed since vehicle is over capacity.  The faster way to address</span>
    <span class="c">#: this is to bump all of those passengers, which means we call the assigned path bad and try</span>
    <span class="c">#: to reassign.</span>
    <span class="c">#:</span>
    <span class="c">#: However, this could over-bump passengers, because if a passenger rides multiple</span>
    <span class="c">#: crowded vehicles, then bumping her frees up space on other vehicles and so some other bumping</span>
    <span class="c">#: may not be necessary.  Thus, the more accurate (but slower) method is to bump passengers from</span>
    <span class="c">#: each (trip,stop) at a time, in order of the full vehicle arrival time, and then recalculate</span>
    <span class="c">#: loads, and iterate until we have no capacity issues.</span>
    <span class="n">BUMP_ONE_AT_A_TIME</span>              <span class="o">=</span> <span class="bp">True</span>

    <span class="c">#: assignment results - Passenger table</span>
    <span class="n">PASSENGERS_CSV</span>                  <span class="o">=</span> <span class="s">r&quot;passengers_df_iter</span><span class="si">%d</span><span class="s">.csv&quot;</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.datetime64_formatter"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.datetime64_formatter">[docs]</a>    <span class="k">def</span> <span class="nf">datetime64_formatter</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Formatter to convert :py:class:`numpy.datetime64` to string that looks like `HH:MM.SS`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%H:%M.%S&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.datetime64_min_formatter"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.datetime64_min_formatter">[docs]</a>    <span class="k">def</span> <span class="nf">datetime64_min_formatter</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Formatter to convert :py:class:`numpy.datetime64` to minutes after minutes</span>
<span class="sd">        (with two decimal places)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">hour</span><span class="o">*</span><span class="mf">60.0</span> <span class="o">+</span> \
                         <span class="n">pandas</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">minute</span> <span class="o">+</span> \
                         <span class="n">pandas</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">second</span><span class="o">/</span><span class="mf">60.0</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.timedelta_formatter"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.timedelta_formatter">[docs]</a>    <span class="k">def</span> <span class="nf">timedelta_formatter</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Formatter to convert :py:class:`numpy.timedelta64` to string that looks like `4m 35.6s`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="n">x</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;s&#39;</span><span class="p">)</span>
        <span class="n">minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">seconds</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">seconds</span> <span class="o">-=</span> <span class="n">minutes</span><span class="o">*</span><span class="mi">60</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%4d</span><span class="s">m </span><span class="si">%04.1f</span><span class="s">s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">minutes</span><span class="p">,</span><span class="n">seconds</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Assignment.__init__"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This does nothing.  Assignment methods are static methods for now.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.read_configuration"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.read_configuration">[docs]</a>    <span class="k">def</span> <span class="nf">read_configuration</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the configuration parameters and override the above</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Not implemented&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.initialize_fasttrips_extension"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.initialize_fasttrips_extension">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_fasttrips_extension</span><span class="p">(</span><span class="n">process_number</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">FT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the C++ fasttrips extension by passing it the network supply.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Initializing fasttrips extension for process number </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">process_number</span><span class="p">)</span>
        <span class="c"># make a copy to convert the 2-column MultiIndex to a 2D array easily</span>
        <span class="n">access_links_df</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">tazs</span><span class="o">.</span><span class="n">access_links_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="c"># create access and egress cost</span>
        <span class="n">access_links_df</span><span class="p">[</span><span class="n">TAZ</span><span class="o">.</span><span class="n">ACCLINKS_COLUMN_ACC_COST</span><span class="p">]</span> <span class="o">=</span> <span class="n">access_links_df</span><span class="p">[</span><span class="n">TAZ</span><span class="o">.</span><span class="n">ACCLINKS_COLUMN_TIME_MIN</span><span class="p">]</span><span class="o">*</span><span class="n">Path</span><span class="o">.</span><span class="n">WALK_ACCESS_TIME_WEIGHT</span>
        <span class="n">access_links_df</span><span class="p">[</span><span class="n">TAZ</span><span class="o">.</span><span class="n">ACCLINKS_COLUMN_EGR_COST</span><span class="p">]</span> <span class="o">=</span> <span class="n">access_links_df</span><span class="p">[</span><span class="n">TAZ</span><span class="o">.</span><span class="n">ACCLINKS_COLUMN_TIME_MIN</span><span class="p">]</span><span class="o">*</span><span class="n">Path</span><span class="o">.</span><span class="n">WALK_EGRESS_TIME_WEIGHT</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">access_links_df</span><span class="o">.</span><span class="n">head</span><span class="p">()))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">access_links_df</span><span class="o">.</span><span class="n">tail</span><span class="p">()))</span>

        <span class="c"># make a copy for index flattening</span>
        <span class="n">stop_times_df</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">trips</span><span class="o">.</span><span class="n">stop_times_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c"># transfers copy for index flattening, cost</span>
        <span class="n">transfers_df</span> <span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">stops</span><span class="o">.</span><span class="n">transfers_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">transfers_df</span><span class="p">[</span><span class="n">Stop</span><span class="o">.</span><span class="n">TRANSFERS_COLUMN_COST</span><span class="p">]</span> <span class="o">=</span> <span class="n">transfers_df</span><span class="p">[</span><span class="n">Stop</span><span class="o">.</span><span class="n">TRANSFERS_COLUMN_TIME_MIN</span><span class="p">]</span><span class="o">*</span><span class="n">Path</span><span class="o">.</span><span class="n">WALK_TRANSFER_TIME_WEIGHT</span>

        <span class="n">_fasttrips</span><span class="o">.</span><span class="n">initialize_supply</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">process_number</span><span class="p">,</span>
                                     <span class="n">access_links_df</span><span class="p">[[</span><span class="n">TAZ</span><span class="o">.</span><span class="n">ACCLINKS_COLUMN_TAZ</span><span class="p">,</span>
                                                      <span class="n">TAZ</span><span class="o">.</span><span class="n">ACCLINKS_COLUMN_STOP</span>    <span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int32&#39;</span><span class="p">),</span>
                                     <span class="n">access_links_df</span><span class="p">[[</span><span class="n">TAZ</span><span class="o">.</span><span class="n">ACCLINKS_COLUMN_TIME_MIN</span><span class="p">,</span>
                                                      <span class="n">TAZ</span><span class="o">.</span><span class="n">ACCLINKS_COLUMN_ACC_COST</span><span class="p">,</span>
                                                      <span class="n">TAZ</span><span class="o">.</span><span class="n">ACCLINKS_COLUMN_EGR_COST</span><span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;float64&#39;</span><span class="p">),</span>
                                     <span class="n">stop_times_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_SEQUENCE</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span><span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int32&#39;</span><span class="p">),</span>
                                     <span class="n">stop_times_df</span><span class="p">[[</span><span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_ARRIVAL_TIME_MIN</span><span class="p">,</span>
                                                    <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DEPARTURE_TIME_MIN</span><span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;float64&#39;</span><span class="p">),</span>
                                     <span class="n">transfers_df</span><span class="p">[[</span><span class="n">Stop</span><span class="o">.</span><span class="n">TRANSFERS_COLUMN_FROM_STOP</span><span class="p">,</span>
                                                   <span class="n">Stop</span><span class="o">.</span><span class="n">TRANSFERS_COLUMN_TO_STOP</span><span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int32&#39;</span><span class="p">),</span>
                                     <span class="n">transfers_df</span><span class="p">[[</span><span class="n">Stop</span><span class="o">.</span><span class="n">TRANSFERS_COLUMN_TIME_MIN</span><span class="p">,</span>
                                                   <span class="n">Stop</span><span class="o">.</span><span class="n">TRANSFERS_COLUMN_COST</span><span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;float64&#39;</span><span class="p">))</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.set_fasttrips_bump_wait"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.set_fasttrips_bump_wait">[docs]</a>    <span class="k">def</span> <span class="nf">set_fasttrips_bump_wait</span><span class="p">(</span><span class="n">bump_wait_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the bump wait information to the fasttrips extension</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_fasttrips</span><span class="o">.</span><span class="n">set_bump_wait</span><span class="p">(</span><span class="n">bump_wait_df</span><span class="p">[[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">,</span><span class="s">&#39;stop_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int32&#39;</span><span class="p">),</span>
                                 <span class="n">bump_wait_df</span><span class="p">[</span><span class="s">&#39;A_time_min&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;float64&#39;</span><span class="p">))</span>

</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.assign_paths"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.assign_paths">[docs]</a>    <span class="k">def</span> <span class="nf">assign_paths</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">FT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the paths for the passengers.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Assignment</span><span class="o">.</span><span class="n">ITERATION_FLAG</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;***************************** ITERATION </span><span class="si">%d</span><span class="s"> **************************************&quot;</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">ASSIGNMENT_TYPE</span> <span class="o">==</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">ASSIGNMENT_TYPE_SIM_ONLY</span> <span class="ow">or</span> \
               <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PASSENGERS_CSV</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">)):</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Simulation only&quot;</span><span class="p">)</span>
                <span class="p">(</span><span class="n">num_paths_found</span><span class="p">,</span> <span class="n">passengers_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">read_assignment_results</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_paths_found</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">generate_paths</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>
                <span class="n">passengers_df</span>      <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">setup_passengers</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>

            <span class="n">veh_trips_df</span>       <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">setup_trips</span><span class="p">(</span><span class="n">FT</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PASSENGER_TRAJECTORIES</span><span class="p">:</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">print_passenger_paths</span><span class="p">(</span><span class="n">passengers_df</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">SIMULATION_FLAG</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;****************************** SIMULATING *****************************&quot;</span><span class="p">)</span>
                <span class="p">(</span><span class="n">num_passengers_arrived</span><span class="p">,</span><span class="n">veh_trips_df</span><span class="p">,</span><span class="n">pax_exp_df</span><span class="p">)</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">passengers_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">OUTPUT_PASSENGER_TRAJECTORIES</span><span class="p">:</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">print_passenger_times</span><span class="p">(</span><span class="n">pax_exp_df</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>

            <span class="c"># capacity gap stuff</span>
            <span class="n">num_bumped_passengers</span> <span class="o">=</span> <span class="n">num_paths_found</span> <span class="o">-</span> <span class="n">num_passengers_arrived</span>
            <span class="n">capacity_gap</span> <span class="o">=</span> <span class="mf">100.0</span><span class="o">*</span><span class="n">num_bumped_passengers</span><span class="o">/</span><span class="n">num_paths_found</span>

            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  TOTAL ASSIGNED PASSENGERS: </span><span class="si">%10d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">num_paths_found</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  ARRIVED PASSENGERS:        </span><span class="si">%10d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">num_passengers_arrived</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  MISSED PASSENGERS:         </span><span class="si">%10d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">num_bumped_passengers</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;  CAPACITY GAP:              </span><span class="si">%10.5f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">capacity_gap</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">capacity_gap</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="ow">or</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">ASSIGNMENT_TYPE</span> <span class="o">==</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">ASSIGNMENT_TYPE_STO_ASGN</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c"># end for loop</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;**************************** WRITING OUTPUTS ****************************&quot;</span><span class="p">)</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">print_load_profile</span><span class="p">(</span><span class="n">veh_trips_df</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.generate_paths"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.generate_paths">[docs]</a>    <span class="k">def</span> <span class="nf">generate_paths</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates paths ofr passengers using deterministic trip-based shortest path (TBSP) or</span>
<span class="sd">        stochastic trip-based hyperpath (TBHP).</span>

<span class="sd">        Returns the number of paths found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;**************************** GENERATING PATHS ****************************&quot;</span><span class="p">)</span>
        <span class="n">start_time</span>          <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">process_list</span>        <span class="o">=</span> <span class="p">[]</span>
        <span class="n">todo_queue</span>          <span class="o">=</span> <span class="bp">None</span>
        <span class="n">done_queue</span>          <span class="o">=</span> <span class="bp">None</span>

        <span class="n">est_paths_to_find</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">est_paths_to_find</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bumped_path_ids</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">reassign_nonlast_paths</span><span class="p">)</span>

        <span class="n">info_freq</span>           <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">est_paths_to_find</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">info_freq</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">info_freq</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">num_processes</span>       <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">NUMBER_OF_PROCESSES</span>
        <span class="k">if</span>  <span class="n">Assignment</span><span class="o">.</span><span class="n">NUMBER_OF_PROCESSES</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">num_processes</span>   <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>

        <span class="c"># this is probalby time consuming... put in a try block</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Setup multiprocessing processes</span>
            <span class="k">if</span> <span class="n">num_processes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">todo_queue</span>      <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
                <span class="n">done_queue</span>      <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">process_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">num_processes</span><span class="p">):</span>
                    <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Starting worker process </span><span class="si">%2d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">process_idx</span><span class="p">)</span>
                    <span class="n">process_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">find_trip_based_paths_process_worker</span><span class="p">,</span>
                                                                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">process_idx</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">FT</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
                                                                      <span class="n">todo_queue</span><span class="p">,</span> <span class="n">done_queue</span><span class="p">,</span>
                                                                      <span class="n">Assignment</span><span class="o">.</span><span class="n">ASSIGNMENT_TYPE</span><span class="o">==</span><span class="n">Assignment</span><span class="o">.</span><span class="n">ASSIGNMENT_TYPE_STO_ASGN</span><span class="p">,</span>
                                                                      <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)))</span>
                    <span class="n">process_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">initialize_fasttrips_extension</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">FT</span><span class="p">)</span>

            <span class="c"># process tasks or send tasks to workers for processing</span>
            <span class="n">num_paths_found_prev</span>  <span class="o">=</span> <span class="mi">0</span>
            <span class="n">num_paths_found_now</span>   <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">path_id</span><span class="p">,</span><span class="n">passenger</span> <span class="ow">in</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">passenger_id</span> <span class="o">=</span> <span class="n">passenger</span><span class="o">.</span><span class="n">passenger_id</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">goes_somewhere</span><span class="p">():</span> <span class="k">continue</span>

                <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">passenger_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">bumped_passenger_ids</span> <span class="ow">and</span> <span class="n">path_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">reassign_nonlast_paths</span><span class="p">:</span>
                    <span class="n">num_paths_found_prev</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">num_processes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">todo_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">(</span><span class="n">passenger</span><span class="p">,</span> <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trace_passenger</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">if</span> <span class="n">passenger_id</span> <span class="ow">in</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">TRACE_PASSENGER_IDS</span><span class="p">:</span>
                        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Tracing assignment of passenger </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">passenger_id</span><span class="p">))</span>
                        <span class="n">trace_passenger</span> <span class="o">=</span> <span class="bp">True</span>

                    <span class="c"># do the work</span>
                    <span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">return_states</span><span class="p">)</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">find_trip_based_path</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">passenger</span><span class="p">,</span> <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                                                                  <span class="n">Assignment</span><span class="o">.</span><span class="n">ASSIGNMENT_TYPE</span><span class="o">==</span><span class="n">Assignment</span><span class="o">.</span><span class="n">ASSIGNMENT_TYPE_STO_ASGN</span><span class="p">,</span>
                                                                                  <span class="n">trace</span><span class="o">=</span><span class="n">trace_passenger</span><span class="p">)</span>
                    <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="n">return_states</span>
                    <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">cost</span>   <span class="o">=</span> <span class="n">cost</span>

                    <span class="k">if</span> <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">path_found</span><span class="p">():</span>
                        <span class="n">num_paths_found_now</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">num_paths_found_now</span> <span class="o">%</span> <span class="n">info_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot; </span><span class="si">%6d</span><span class="s"> / </span><span class="si">%6d</span><span class="s"> passenger paths found.  Time elapsed: </span><span class="si">%2d</span><span class="s">h:</span><span class="si">%2d</span><span class="s">m:</span><span class="si">%2d</span><span class="s">s&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                             <span class="n">num_paths_found_now</span><span class="p">,</span> <span class="n">est_paths_to_find</span><span class="p">,</span>
                                             <span class="nb">int</span><span class="p">(</span> <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">),</span>
                                             <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">),</span>
                                             <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">60</span><span class="p">))</span>

            <span class="c"># multiprocessing follow-up</span>
            <span class="k">if</span> <span class="n">num_processes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c"># we&#39;re done, let each process know</span>
                <span class="k">for</span> <span class="n">process_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">process_list</span><span class="p">)):</span>
                    <span class="n">todo_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;DONE&#39;</span><span class="p">)</span>

                <span class="c"># get results</span>
                <span class="n">done_procs</span>          <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">done_procs</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">process_list</span><span class="p">):</span>

                    <span class="n">result</span> <span class="o">=</span> <span class="n">done_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&#39;DONE&#39;</span><span class="p">:</span>
                        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Received done&quot;</span><span class="p">)</span>
                        <span class="n">done_procs</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">passenger_id</span>    <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">path_id</span>         <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                        <span class="c"># find passenger with path_id and set return</span>
                        <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="p">[</span><span class="n">path_id</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">cost</span>   <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="p">[</span><span class="n">path_id</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="p">[</span><span class="n">path_id</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">path_found</span><span class="p">():</span>
                            <span class="n">num_paths_found_now</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="k">if</span> <span class="n">num_paths_found_now</span> <span class="o">%</span> <span class="n">info_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot; </span><span class="si">%6d</span><span class="s"> / </span><span class="si">%6d</span><span class="s"> passenger paths found.  Time elapsed: </span><span class="si">%2d</span><span class="s">h:</span><span class="si">%2d</span><span class="s">m:</span><span class="si">%2d</span><span class="s">s&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                                 <span class="n">num_paths_found_now</span><span class="p">,</span> <span class="n">est_paths_to_find</span><span class="p">,</span>
                                                 <span class="nb">int</span><span class="p">(</span> <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">),</span>
                                                 <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">),</span>
                                                 <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">60</span><span class="p">))</span>

                <span class="c"># join up my processes</span>
                <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">process_list</span><span class="p">:</span>
                    <span class="n">proc</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Exception caught: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_type</span><span class="p">))</span>
            <span class="n">error_lines</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">error_lines</span><span class="p">:</span> <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Terminating processes&quot;</span><span class="p">)</span>
            <span class="c"># terminating my processes</span>
            <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">process_list</span><span class="p">:</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c"># some other error</span>
            <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">error_lines</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">error_lines</span><span class="p">:</span> <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Finished finding </span><span class="si">%6d</span><span class="s"> passenger paths.  Time elapsed: </span><span class="si">%2d</span><span class="s">h:</span><span class="si">%2d</span><span class="s">m:</span><span class="si">%2d</span><span class="s">s&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                 <span class="n">num_paths_found_now</span><span class="p">,</span>
                                 <span class="nb">int</span><span class="p">(</span> <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">),</span>
                                 <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">),</span>
                                 <span class="n">time_elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">%</span> <span class="mi">60</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">num_paths_found_now</span> <span class="o">+</span> <span class="n">num_paths_found_prev</span>

</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.find_trip_based_path"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.find_trip_based_path">[docs]</a>    <span class="k">def</span> <span class="nf">find_trip_based_path</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">passenger</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">hyperpath</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform trip-based path search.</span>

<span class="sd">        Will do so either backwards (destination to origin) if :py:attr:`Path.direction` is :py:attr:`Path.DIR_OUTBOUND`</span>
<span class="sd">        or forwards (origin to destination) if :py:attr:`Path.direction` is :py:attr:`Path.DIR_INBOUND`.</span>

<span class="sd">        Returns (path cost, return_states).</span>

<span class="sd">        :param FT: fasttrips data</span>
<span class="sd">        :type FT: a :py:class:`FastTrips` instance</span>
<span class="sd">        :param passenger: the passenger whose path we&#39;re finding</span>
<span class="sd">        :type passenger: a :py:class:`Passenger` instance</span>
<span class="sd">        :param path: the path to fill in</span>
<span class="sd">        :type path: a :py:class:`Path` instance</span>
<span class="sd">        :param hyperpath: pass True to use a stochastic hyperpath-finding algorithm, otherwise a deterministic shortest path</span>
<span class="sd">                          search algorithm will be use.</span>
<span class="sd">        :type hyperpath: boolean</span>
<span class="sd">        :param trace: pass True if this path should be traced to the debug log</span>
<span class="sd">        :type trace: boolean</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># FastTripsLogger.debug(&quot;C++ extension start&quot;)</span>
        <span class="c"># send it to the C++ extension</span>
        <span class="p">(</span><span class="n">ret_ints</span><span class="p">,</span> <span class="n">ret_doubles</span><span class="p">,</span> <span class="n">path_cost</span><span class="p">)</span> <span class="o">=</span> \
            <span class="n">_fasttrips</span><span class="o">.</span><span class="n">find_path</span><span class="p">(</span><span class="n">passenger</span><span class="o">.</span><span class="n">passenger_id</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">path_id</span><span class="p">,</span> <span class="n">hyperpath</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">origin_taz_id</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">destination_taz_id</span><span class="p">,</span>
                                 <span class="mi">1</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">outbound</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">pref_time_min</span><span class="p">),</span>
                                 <span class="mi">1</span> <span class="k">if</span> <span class="n">trace</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c"># FastTripsLogger.debug(&quot;C++ extension complete&quot;)</span>

        <span class="c"># Put the results into an ordered dict statelist</span>
        <span class="n">return_states</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">midnight</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">TODAY</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ret_ints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">ret_ints</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">STATE_MODE_ACCESS</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">101</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">STATE_MODE_EGRESS</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="o">-</span><span class="mi">102</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">STATE_MODE_TRANSFER</span>

            <span class="k">if</span> <span class="n">hyperpath</span><span class="p">:</span>
                <span class="n">return_states</span><span class="p">[</span><span class="n">ret_ints</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
                              <span class="n">ret_doubles</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>                                         <span class="c"># label,</span>
                              <span class="n">midnight</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span>  <span class="c"># departure/arrival time</span>
                              <span class="n">mode</span><span class="p">,</span>                                                         <span class="c"># departure/arrival mode</span>
                              <span class="n">ret_ints</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>                                            <span class="c"># successor/predecessor</span>
                              <span class="n">ret_ints</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>                                            <span class="c"># sequence</span>
                              <span class="n">ret_ints</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>                                            <span class="c"># sequence succ/pred</span>
                              <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span>             <span class="c"># link time</span>
                              <span class="n">ret_doubles</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>                                         <span class="c"># cost</span>
                              <span class="n">midnight</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>   <span class="c"># arrival/departure time</span>
                              <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">return_states</span><span class="p">[</span><span class="n">ret_ints</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
                              <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span>              <span class="c"># label,</span>
                              <span class="n">midnight</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span>  <span class="c"># departure/arrival time</span>
                              <span class="n">mode</span><span class="p">,</span>                                                         <span class="c"># departure/arrival mode</span>
                              <span class="n">ret_ints</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>                                            <span class="c"># successor/predecessor</span>
                              <span class="n">ret_ints</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>                                            <span class="c"># sequence</span>
                              <span class="n">ret_ints</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>                                            <span class="c"># sequence succ/pred</span>
                              <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span>             <span class="c"># link time</span>
                              <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">3</span><span class="p">]),</span>             <span class="c"># cost</span>
                              <span class="n">midnight</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">ret_doubles</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>   <span class="c"># arrival/departure time</span>
                              <span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">path_cost</span><span class="p">,</span> <span class="n">return_states</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.print_passenger_paths"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.print_passenger_paths">[docs]</a>    <span class="k">def</span> <span class="nf">print_passenger_paths</span><span class="p">(</span><span class="n">passengers_df</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the passenger paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">paths_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">&quot;ft_output_passengerPaths.dat&quot;</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">Path</span><span class="o">.</span><span class="n">write_paths</span><span class="p">(</span><span class="n">passengers_df</span><span class="p">,</span> <span class="n">paths_out</span><span class="p">)</span>
        <span class="n">paths_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.print_passenger_times"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.print_passenger_times">[docs]</a>    <span class="k">def</span> <span class="nf">print_passenger_times</span><span class="p">(</span><span class="n">pax_exp_df</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the passenger times.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># reset columns</span>
        <span class="n">print_pax_exp_df</span> <span class="o">=</span> <span class="n">pax_exp_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">print_pax_exp_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">print_pax_exp_df</span><span class="p">[</span><span class="s">&#39;A_time_str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">print_pax_exp_df</span><span class="p">[</span><span class="s">&#39;A_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">)</span>
        <span class="n">print_pax_exp_df</span><span class="p">[</span><span class="s">&#39;B_time_str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">print_pax_exp_df</span><span class="p">[</span><span class="s">&#39;B_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">)</span>

        <span class="c"># rename columns</span>
        <span class="n">print_pax_exp_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span>
            <span class="p">{</span><span class="s">&#39;passenger_id&#39;</span>         <span class="p">:</span><span class="s">&#39;passengerId&#39;</span><span class="p">,</span>
             <span class="s">&#39;pathmode&#39;</span>             <span class="p">:</span><span class="s">&#39;mode&#39;</span><span class="p">,</span>
             <span class="s">&#39;A_id&#39;</span>                 <span class="p">:</span><span class="s">&#39;originTaz&#39;</span><span class="p">,</span>
             <span class="s">&#39;B_id&#39;</span>                 <span class="p">:</span><span class="s">&#39;destinationTaz&#39;</span><span class="p">,</span>
             <span class="s">&#39;A_time_str&#39;</span>           <span class="p">:</span><span class="s">&#39;startTime&#39;</span><span class="p">,</span>
             <span class="s">&#39;B_time_str&#39;</span>           <span class="p">:</span><span class="s">&#39;endTime&#39;</span><span class="p">,</span>
             <span class="s">&#39;arrival_time_str&#39;</span>     <span class="p">:</span><span class="s">&#39;arrivalTimes&#39;</span><span class="p">,</span>
             <span class="s">&#39;board_time_str&#39;</span>       <span class="p">:</span><span class="s">&#39;boardingTimes&#39;</span><span class="p">,</span>
             <span class="s">&#39;alight_time_str&#39;</span>      <span class="p">:</span><span class="s">&#39;alightingTimes&#39;</span><span class="p">,</span>
             <span class="s">&#39;cost&#39;</span>                 <span class="p">:</span><span class="s">&#39;travelCost&#39;</span><span class="p">,</span>
             <span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># recode/reformat</span>
        <span class="n">print_pax_exp_df</span><span class="p">[[</span><span class="s">&#39;originTaz&#39;</span><span class="p">,</span><span class="s">&#39;destinationTaz&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">print_pax_exp_df</span><span class="p">[[</span><span class="s">&#39;originTaz&#39;</span><span class="p">,</span><span class="s">&#39;destinationTaz&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c"># reorder</span>
        <span class="n">print_pax_exp_df</span> <span class="o">=</span> <span class="n">print_pax_exp_df</span><span class="p">[[</span>
            <span class="s">&#39;passengerId&#39;</span><span class="p">,</span>
            <span class="s">&#39;mode&#39;</span><span class="p">,</span>
            <span class="s">&#39;originTaz&#39;</span><span class="p">,</span>
            <span class="s">&#39;destinationTaz&#39;</span><span class="p">,</span>
            <span class="s">&#39;startTime&#39;</span><span class="p">,</span>
            <span class="s">&#39;endTime&#39;</span><span class="p">,</span>
            <span class="s">&#39;arrivalTimes&#39;</span><span class="p">,</span>
            <span class="s">&#39;boardingTimes&#39;</span><span class="p">,</span>
            <span class="s">&#39;alightingTimes&#39;</span><span class="p">,</span>
            <span class="s">&#39;travelCost&#39;</span><span class="p">]]</span>

        <span class="n">times_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">&quot;ft_output_passengerTimes.dat&quot;</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">print_pax_exp_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">times_out</span><span class="p">,</span>
                                <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">times_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.read_assignment_results"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.read_assignment_results">[docs]</a>    <span class="k">def</span> <span class="nf">read_assignment_results</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads assignment results from :py:attr:`Assignment.PASSENGERS_CSV`</span>

<span class="sd">        :param output_dir: Location of csv files to read</span>
<span class="sd">        :type output_dir: string</span>
<span class="sd">        :param iteration: The iteration label for the csv files to read</span>
<span class="sd">        :type iteration: integer</span>
<span class="sd">        :return: The number of paths assigned, the paths.  See :py:meth:`Assignment.setup_passengers`</span>
<span class="sd">                 for documentation on the passenger paths :py:class:`pandas.DataFrame`</span>
<span class="sd">        :rtype: a tuple of (int, :py:class:`pandas.DataFrame`)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># read existing paths</span>
        <span class="n">passengers_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PASSENGERS_CSV</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">),</span>
                                        <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;A_time&#39;</span><span class="p">,</span><span class="s">&#39;B_time&#39;</span><span class="p">])</span>
        <span class="n">passengers_df</span><span class="p">[</span><span class="s">&#39;linktime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">passengers_df</span><span class="p">[</span><span class="s">&#39;linktime&#39;</span><span class="p">])</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Read </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PASSENGERS_CSV</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;passengers_df.dtypes=</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">passengers_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>

        <span class="n">uniq_pax</span> <span class="o">=</span> <span class="n">passengers_df</span><span class="p">[[</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">])</span>
        <span class="n">num_paths_found</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniq_pax</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">num_paths_found</span><span class="p">,</span> <span class="n">passengers_df</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.setup_passengers"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.setup_passengers">[docs]</a>    <span class="k">def</span> <span class="nf">setup_passengers</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts assignment results (which is stored in each Passenger :py:class:`Path`,</span>
<span class="sd">        in the :py:attr:`Path.states`) into a single :py:class:`pandas.DataFrame`.  Each row</span>
<span class="sd">        represents a link in the passenger&#39;s path.  The returned :py:class:`pandas.DataFrame`</span>
<span class="sd">        has the following columns:</span>

<span class="sd">        ==============  ===============  =====================================================================================================</span>
<span class="sd">        column name      column type     description</span>
<span class="sd">        ==============  ===============  =====================================================================================================</span>
<span class="sd">        `passenger_id`            int64  the :py:attr:`Passenger.passenger_id`</span>
<span class="sd">        `path_id`                 int64  a sequential integer ID unique to each :py:class:`Path` instance</span>
<span class="sd">        `pathdir`                 int64  the :py:attr:`Path.direction`</span>
<span class="sd">        `pathmode`                int64  the :py:attr:`Path.mode`</span>
<span class="sd">        `linkmode`               object  the mode of the link, one of :py:attr:`Path.STATE_MODE_ACCESS`, :py:attr:`Path.STATE_MODE_EGRESS`,</span>
<span class="sd">                                         :py:attr:`Path.STATE_MODE_TRANSFER` or :py:attr:`Path.STATE_MODE_TRIP`.  Paths will always start with</span>
<span class="sd">                                         access, followed by trips with transfers in between, and ending in an egress following the last trip.</span>
<span class="sd">        `trip_id`               float64  the :py:attr:`Trip.trip_id` for trip links.  Set to :py:attr:`numpy.nan` for non-trip links.</span>
<span class="sd">        `A_id`                  float64  the :py:attr:`Stop.stop_id` at the start of the link, or a :py:attr:`TAZ.taz_id` for access links</span>
<span class="sd">        `B_id`                  float64  the :py:attr:`Stop.stop_id` at the end of the link, or a :py:attr:`TAZ.taz_id` for access links</span>
<span class="sd">        `A_seq`,                  int64  the sequence number for the stop at the start of the link, or -1 for access links</span>
<span class="sd">        `B_seq`,                  int64  the sequence number for the stop at the start of the link, or -1 for access links</span>
<span class="sd">        `A_time`         datetime64[ns]  the time the passenger arrives at `A_id`</span>
<span class="sd">        `B_time`         datetime64[ns]  the time the passenger arrives at `B_id`</span>
<span class="sd">        `linktime`      timedelta64[ns]  the time spent on the link</span>
<span class="sd">        `cost`                  float64  the cost of the entire path</span>
<span class="sd">        ==============  ===============  =====================================================================================================</span>

<span class="sd">        Additionally, this method writes out the dataframe to a csv at :py:attr:`Assignment.PASSENGERS_CSV` in the given `output_dir`</span>
<span class="sd">        and labeled with the given `iteration`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mylist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path_id</span><span class="p">,</span><span class="n">passenger</span> <span class="ow">in</span> <span class="n">FT</span><span class="o">.</span><span class="n">passengers</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">goes_somewhere</span><span class="p">():</span>   <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">path_found</span><span class="p">():</span>       <span class="k">continue</span>

            <span class="c"># OUTBOUND passengers have states like this:</span>
            <span class="c">#    stop:          label    departure   dep_mode  successor linktime</span>
            <span class="c"># orig_taz                                 Access    b stop1</span>
            <span class="c">#  b stop1                                  trip1    a stop2</span>
            <span class="c">#  a stop2                               Transfer    b stop3</span>
            <span class="c">#  b stop3                                  trip2    a stop4</span>
            <span class="c">#  a stop4                                 Egress   dest_taz</span>
            <span class="c">#</span>
            <span class="c">#  stop:         label  dep_time    dep_mode   successor  seq  suc       linktime             cost  arr_time</span>
            <span class="c">#   460:  0:20:49.4000  17:41:10      Access        3514   -1   -1   0:03:08.4000     0:03:08.4000  17:44:18</span>
            <span class="c">#  3514:  0:17:41.0000  17:44:18     5131292        4313   30   40   0:06:40.0000     0:12:21.8000  17:50:59</span>
            <span class="c">#  4313:  0:05:19.2000  17:50:59    Transfer        5728   -1   -1   0:00:19.2000     0:00:19.2000  17:51:18</span>
            <span class="c">#  5728:  0:04:60.0000  17:57:00     5154302        5726   16   17   0:07:33.8000     0:03:02.4000  17:58:51</span>
            <span class="c">#  5726:  0:01:57.6000  17:58:51      Egress         231   -1   -1   0:01:57.6000     0:01:57.6000  18:00:49</span>

            <span class="c"># INBOUND passengers have states like this</span>
            <span class="c">#   stop:          label      arrival   arr_mode predecessor linktime</span>
            <span class="c"># dest_taz                                 Egress    a stop4</span>
            <span class="c">#  a stop4                                  trip2    b stop3</span>
            <span class="c">#  b stop3                               Transfer    a stop2</span>
            <span class="c">#  a stop2                                  trip1    b stop1</span>
            <span class="c">#  b stop1                                 Access   orig_taz</span>
            <span class="c">#</span>
            <span class="c">#  stop:         label  arr_time    arr_mode predecessor  seq pred       linktime             cost  dep_time</span>
            <span class="c">#    15:  0:36:38.4000  17:30:38      Egress        3772   -1   -1   0:02:38.4000     0:02:38.4000  17:28:00</span>
            <span class="c">#  3772:  0:34:00.0000  17:28:00     5123368        6516   22   14   0:24:17.2000     0:24:17.2000  17:05:50</span>
            <span class="c">#  6516:  0:09:42.8000  17:03:42    Transfer        4766   -1   -1   0:00:16.8000     0:00:16.8000  17:03:25</span>
            <span class="c">#  4766:  0:09:26.0000  17:03:25     5138749        5671    7    3   0:05:30.0000     0:05:33.2000  16:57:55</span>
            <span class="c">#  5671:  0:03:52.8000  16:57:55      Access         943   -1   -1   0:03:52.8000     0:03:52.8000  16:54:03</span>
            <span class="n">prev_linkmode</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">prev_state_id</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">states</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">state_list</span> <span class="o">=</span> <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">outbound</span><span class="p">():</span> <span class="n">state_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">state_list</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">state_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state_list</span><span class="p">)):</span>
                    <span class="n">state_id</span>        <span class="o">=</span> <span class="n">state_list</span><span class="p">[</span><span class="n">state_index</span><span class="p">]</span>

                    <span class="n">state</span>           <span class="o">=</span> <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">state_id</span><span class="p">]</span>
                    <span class="n">linkmode</span>        <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">Path</span><span class="o">.</span><span class="n">STATE_IDX_DEPARRMODE</span><span class="p">]</span>
                    <span class="n">trip_id</span>         <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">if</span> <span class="n">linkmode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Path</span><span class="o">.</span><span class="n">STATE_MODE_ACCESS</span><span class="p">,</span> <span class="n">Path</span><span class="o">.</span><span class="n">STATE_MODE_TRANSFER</span><span class="p">,</span> <span class="n">Path</span><span class="o">.</span><span class="n">STATE_MODE_EGRESS</span><span class="p">]:</span>
                        <span class="n">trip_id</span>     <span class="o">=</span> <span class="n">linkmode</span>
                        <span class="n">linkmode</span>    <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">STATE_MODE_TRIP</span>

                    <span class="k">if</span> <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">outbound</span><span class="p">():</span>
                        <span class="n">a_id</span>        <span class="o">=</span> <span class="n">state_id</span>
                        <span class="n">b_id</span>        <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">Path</span><span class="o">.</span><span class="n">STATE_IDX_SUCCPRED</span><span class="p">]</span>
                        <span class="n">a_seq</span>       <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">Path</span><span class="o">.</span><span class="n">STATE_IDX_SEQ</span><span class="p">]</span>
                        <span class="n">b_seq</span>       <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">Path</span><span class="o">.</span><span class="n">STATE_IDX_SEQ_SUCCPRED</span><span class="p">]</span>
                        <span class="n">b_time</span>      <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">Path</span><span class="o">.</span><span class="n">STATE_IDX_ARRDEP</span><span class="p">]</span>
                        <span class="n">a_time</span>      <span class="o">=</span> <span class="n">b_time</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="n">Path</span><span class="o">.</span><span class="n">STATE_IDX_LINKTIME</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">a_id</span>        <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">Path</span><span class="o">.</span><span class="n">STATE_IDX_SUCCPRED</span><span class="p">]</span>
                        <span class="n">b_id</span>        <span class="o">=</span> <span class="n">state_id</span>
                        <span class="n">a_seq</span>       <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">Path</span><span class="o">.</span><span class="n">STATE_IDX_SEQ_SUCCPRED</span><span class="p">]</span>
                        <span class="n">b_seq</span>       <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">Path</span><span class="o">.</span><span class="n">STATE_IDX_SEQ</span><span class="p">]</span>
                        <span class="n">b_time</span>      <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">Path</span><span class="o">.</span><span class="n">STATE_IDX_DEPARR</span><span class="p">]</span>
                        <span class="n">a_time</span>      <span class="o">=</span> <span class="n">b_time</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="n">Path</span><span class="o">.</span><span class="n">STATE_IDX_LINKTIME</span><span class="p">]</span>

                    <span class="c"># two trips in a row -- insert zero-walk transfer</span>
                    <span class="k">if</span> <span class="n">linkmode</span> <span class="o">==</span> <span class="n">Path</span><span class="o">.</span><span class="n">STATE_MODE_TRIP</span> <span class="ow">and</span> <span class="n">prev_linkmode</span> <span class="o">==</span> <span class="n">Path</span><span class="o">.</span><span class="n">STATE_MODE_TRIP</span><span class="p">:</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">passenger</span><span class="o">.</span><span class="n">passenger_id</span><span class="p">,</span>
                               <span class="n">path_id</span><span class="p">,</span>
                               <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span>
                               <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                               <span class="n">Path</span><span class="o">.</span><span class="n">STATE_MODE_TRANSFER</span><span class="p">,</span>
                               <span class="bp">None</span><span class="p">,</span>
                               <span class="n">a_id</span><span class="p">,</span>
                               <span class="n">a_id</span><span class="p">,</span>
                               <span class="n">a_seq</span><span class="p">,</span>
                               <span class="n">a_seq</span><span class="p">,</span>
                               <span class="n">a_time</span><span class="p">,</span>
                               <span class="n">a_time</span><span class="p">,</span>
                               <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(),</span>
                               <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
                              <span class="p">]</span>
                        <span class="n">mylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

                    <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">passenger</span><span class="o">.</span><span class="n">passenger_id</span><span class="p">,</span>
                           <span class="n">path_id</span><span class="p">,</span>
                           <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span>
                           <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                           <span class="n">linkmode</span><span class="p">,</span>
                           <span class="n">trip_id</span><span class="p">,</span>
                           <span class="n">a_id</span><span class="p">,</span>
                           <span class="n">b_id</span><span class="p">,</span>
                           <span class="n">a_seq</span><span class="p">,</span>
                           <span class="n">b_seq</span><span class="p">,</span>
                           <span class="n">a_time</span><span class="p">,</span>
                           <span class="n">b_time</span><span class="p">,</span>
                           <span class="n">state</span><span class="p">[</span><span class="n">Path</span><span class="o">.</span><span class="n">STATE_IDX_LINKTIME</span><span class="p">],</span>
                           <span class="n">passenger</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span>
                           <span class="p">]</span>
                    <span class="n">mylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

                    <span class="n">prev_linkmode</span> <span class="o">=</span> <span class="n">linkmode</span>
                    <span class="n">prev_state_id</span> <span class="o">=</span> <span class="n">state_id</span>

        <span class="n">df</span> <span class="o">=</span>  <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mylist</span><span class="p">,</span>
                               <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span> <span class="s">&#39;path_id&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;pathdir&#39;</span><span class="p">,</span>  <span class="c"># for debugging</span>
                                        <span class="s">&#39;pathmode&#39;</span><span class="p">,</span> <span class="c"># for output</span>
                                        <span class="s">&#39;linkmode&#39;</span><span class="p">,</span> <span class="s">&#39;trip_id&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;A_id&#39;</span><span class="p">,</span><span class="s">&#39;B_id&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;A_seq&#39;</span><span class="p">,</span><span class="s">&#39;B_seq&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;A_time&#39;</span><span class="p">,</span> <span class="s">&#39;B_time&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;linktime&#39;</span><span class="p">,</span> <span class="s">&#39;cost&#39;</span><span class="p">])</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Setup passengers dataframe:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PASSENGERS_CSV</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Wrote passengers dataframe to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">PASSENGERS_CSV</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">df</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.setup_trips"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.setup_trips">[docs]</a>    <span class="k">def</span> <span class="nf">setup_trips</span><span class="p">(</span><span class="n">FT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up and returns a :py:class:`pandas.DataFrame` where each row contains a leg of a transit vehicle trip.</span>
<span class="sd">        # 2015-06-22 15:42:34 DEBUG Setup vehicle trips dataframe:</span>
<span class="sd">        # routeId                  int64</span>
<span class="sd">        # shapeId                  int64</span>
<span class="sd">        # direction                int64</span>
<span class="sd">        # trip_id                  int64</span>
<span class="sd">        # stop_seq                 int64</span>
<span class="sd">        # stop_id                  int64</span>
<span class="sd">        # capacity                 int64</span>
<span class="sd">        # arrive_time     datetime64[ns]</span>
<span class="sd">        # depart_time     datetime64[ns]</span>
<span class="sd">        # service_type             int64</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># join with trips to get additional fields</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">trips</span><span class="o">.</span><span class="n">stop_times_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                          <span class="n">right</span><span class="o">=</span> <span class="n">FT</span><span class="o">.</span><span class="n">trips</span><span class="o">.</span><span class="n">trips_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                          <span class="n">how</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">)</span>
        <span class="c"># print df.head()</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FT</span><span class="o">.</span><span class="n">trips</span><span class="o">.</span><span class="n">stop_times_df</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span>
           <span class="p">{</span><span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_DIRECTION_ID</span>      <span class="p">:</span><span class="s">&#39;direction&#39;</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_TRIP_ID</span>       <span class="p">:</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_SEQUENCE</span>      <span class="p">:</span><span class="s">&#39;stop_seq&#39;</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_STOP_ID</span>       <span class="p">:</span><span class="s">&#39;stop_id&#39;</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_CAPACITY</span>          <span class="p">:</span><span class="s">&#39;capacity&#39;</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_ARRIVAL_TIME</span>  <span class="p">:</span><span class="s">&#39;arrive_time&#39;</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">STOPTIMES_COLUMN_DEPARTURE_TIME</span><span class="p">:</span><span class="s">&#39;depart_time&#39;</span><span class="p">,</span>
            <span class="n">Trip</span><span class="o">.</span><span class="n">TRIPS_COLUMN_SERVICE_TYPE</span>      <span class="p">:</span><span class="s">&#39;service_type&#39;</span>
            <span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.simulate"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.simulate">[docs]</a>    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">FT</span><span class="p">,</span> <span class="n">passengers_df</span><span class="p">,</span> <span class="n">veh_trips_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Actually assign the passengers trips to the vehicles.</span>

<span class="sd">        .. todo:: Remove step zero.  Duplicate passenger IDs should be ok because we can generate unique path IDs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">passengers_df_len</span>       <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">passengers_df</span><span class="p">)</span>
        <span class="n">veh_trips_df_len</span>        <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">veh_trips_df</span><span class="p">)</span>

        <span class="c">######################################################################################################</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Step 0. Drop passengers with duplicate passenger IDs to match old FAST-TrIPs behavior&quot;</span><span class="p">)</span>
        <span class="c"># TODO: Remove this.</span>
        <span class="c">#  Old FAST-TrIPs handles multiple trips for a single passenger ID by dropping the first</span>
        <span class="c"># ones.  Replicate that here.</span>
        <span class="n">passengers_dedupe</span>       <span class="o">=</span> <span class="n">passengers_df</span><span class="p">[[</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">passengers_dedupe</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="n">take_last</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">passengers_dedupe</span><span class="p">[</span><span class="s">&#39;keep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># these are the passengers we dropped from simulation</span>
        <span class="n">paths_not_kept</span> <span class="o">=</span> <span class="n">passengers_df</span><span class="p">[[</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">paths_not_kept</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">paths_not_kept</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>   <span class="o">=</span><span class="n">paths_not_kept</span><span class="p">,</span>             <span class="n">right</span>   <span class="o">=</span><span class="n">passengers_dedupe</span><span class="p">,</span>
                                      <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">],</span>
                                      <span class="n">how</span>    <span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">paths_not_kept</span> <span class="o">=</span> <span class="n">paths_not_kept</span><span class="p">[</span><span class="n">paths_not_kept</span><span class="o">.</span><span class="n">keep</span><span class="o">!=</span><span class="bp">True</span><span class="p">]</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">reassign_nonlast_paths</span> <span class="o">=</span> <span class="n">paths_not_kept</span><span class="o">.</span><span class="n">path_id</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">passengers_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>   <span class="o">=</span><span class="n">passengers_df</span><span class="p">,</span>              <span class="n">right</span>   <span class="o">=</span><span class="n">passengers_dedupe</span><span class="p">,</span>
                                     <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">],</span>
                                     <span class="n">how</span>    <span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">passengers_df</span> <span class="o">=</span> <span class="n">passengers_df</span><span class="p">[</span><span class="n">passengers_df</span><span class="o">.</span><span class="n">keep</span><span class="o">==</span><span class="bp">True</span><span class="p">]</span>
        <span class="n">passengers_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">&#39;keep&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot; -&gt; Went from </span><span class="si">%d</span><span class="s"> passengers to </span><span class="si">%d</span><span class="s"> passengers&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">passengers_df_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">passengers_df</span><span class="p">)))</span>
        <span class="n">passengers_df_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">passengers_df</span><span class="p">)</span>



        <span class="c"># veh_trips_df.set_index([&#39;trip_id&#39;,&#39;stop_seq&#39;,&#39;stop_id&#39;],verify_integrity=True,inplace=True)</span>
        <span class="c"># FastTripsLogger.debug(&quot;veh_trips_df types = \n%s&quot; % str(veh_trips_df.dtypes))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;veh_trips_df: </span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">veh_trips_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">veh_trips_df</span><span class="o">.</span><span class="n">trip_id</span><span class="o">==</span><span class="mi">5127716</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">formatters</span><span class="o">=</span>
            <span class="p">{</span><span class="s">&#39;arrive_time&#39;</span>          <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">,</span>
             <span class="s">&#39;depart_time&#39;</span>          <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">,</span>
             <span class="s">&#39;waitqueue_start_time&#39;</span> <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">}))</span>

        <span class="k">for</span> <span class="n">trace_pax</span> <span class="ow">in</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">TRACE_PASSENGER_IDS</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Initial passengers_df for </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
               <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">trace_pax</span><span class="p">),</span>
                <span class="n">passengers_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">passengers_df</span><span class="o">.</span><span class="n">passenger_id</span><span class="o">==</span><span class="n">trace_pax</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">formatters</span><span class="o">=</span>\
               <span class="p">{</span><span class="s">&#39;A_time&#39;</span>               <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">,</span>
                <span class="s">&#39;B_time&#39;</span>               <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">,</span>
                <span class="s">&#39;linktime&#39;</span>             <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">timedelta_formatter</span><span class="p">})))</span>

        <span class="c">######################################################################################################</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Step 1. Find out board/alight times for passengers from vehicle times&quot;</span><span class="p">)</span>

        <span class="n">passenger_trips</span> <span class="o">=</span> <span class="n">passengers_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">passengers_df</span><span class="o">.</span><span class="n">linkmode</span><span class="o">==</span><span class="s">&#39;Trip&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">passenger_trips_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">passenger_trips</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;       Have </span><span class="si">%d</span><span class="s"> pasenger trips&quot;</span> <span class="o">%</span> <span class="n">passenger_trips_len</span><span class="p">)</span>

        <span class="n">passenger_trips</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>   <span class="o">=</span><span class="n">passenger_trips</span><span class="p">,</span>              <span class="n">right</span>   <span class="o">=</span><span class="n">veh_trips_df</span><span class="p">[[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">,</span><span class="s">&#39;stop_id&#39;</span><span class="p">,</span><span class="s">&#39;depart_time&#39;</span><span class="p">]],</span>
                                       <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;A_id&#39;</span><span class="p">,</span><span class="s">&#39;A_seq&#39;</span><span class="p">],</span>   <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">],</span>
                                       <span class="n">how</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">passenger_trips</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>   <span class="o">=</span><span class="n">passenger_trips</span><span class="p">,</span>              <span class="n">right</span>   <span class="o">=</span><span class="n">veh_trips_df</span><span class="p">[[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">,</span><span class="s">&#39;stop_id&#39;</span><span class="p">,</span><span class="s">&#39;arrive_time&#39;</span><span class="p">]],</span>
                                       <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;B_id&#39;</span><span class="p">,</span><span class="s">&#39;B_seq&#39;</span><span class="p">],</span>   <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">],</span>
                                       <span class="n">how</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">passenger_trips</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span>
           <span class="p">{</span><span class="s">&#39;depart_time&#39;</span>   <span class="p">:</span><span class="s">&#39;board_time&#39;</span><span class="p">,</span>      <span class="c"># transit vehicle depart time (at A) = board time for pax</span>
            <span class="s">&#39;A_time&#39;</span>        <span class="p">:</span><span class="s">&#39;arrival_time&#39;</span><span class="p">,</span>    <span class="c"># passenger arrival at the stop</span>
            <span class="s">&#39;arrive_time&#39;</span>   <span class="p">:</span><span class="s">&#39;alight_time&#39;</span><span class="p">,</span>     <span class="c"># transit vehicle arrive time (at B) = alight time for pax</span>
            <span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c"># redundant with A_id, B_id, A_seq, B_seq</span>
        <span class="n">passenger_trips</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">&#39;stop_id_x&#39;</span><span class="p">,</span><span class="s">&#39;stop_id_y&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq_x&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq_y&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;       Have </span><span class="si">%d</span><span class="s"> pasenger trips&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">passenger_trips</span><span class="p">))</span>

        <span class="c">######################################################################################################</span>
        <span class="n">bump_iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">bumped_passenger_ids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">bumped_path_ids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span> <span class="c"># loop for capacity constraint</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Step 2. Put passenger paths on transit vehicles to get vehicle boards/alights/load&quot;</span><span class="p">)</span>

            <span class="c"># Group to boards by counting path_ids for a (trip_id, A_id as stop_id)</span>
            <span class="n">passenger_trips_boards</span> <span class="o">=</span> <span class="n">passenger_trips</span><span class="p">[[</span><span class="s">&#39;path_id&#39;</span><span class="p">,</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;A_id&#39;</span><span class="p">,</span><span class="s">&#39;A_seq&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;A_id&#39;</span><span class="p">,</span><span class="s">&#39;A_seq&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="n">passenger_trips_boards</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">]</span>

            <span class="c"># And alights by counting path_ids for a (trip_id, B_id as stop_id)</span>
            <span class="n">passenger_trips_alights</span> <span class="o">=</span> <span class="n">passenger_trips</span><span class="p">[[</span><span class="s">&#39;path_id&#39;</span><span class="p">,</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;B_id&#39;</span><span class="p">,</span><span class="s">&#39;B_seq&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;B_id&#39;</span><span class="p">,</span><span class="s">&#39;B_seq&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="n">passenger_trips_alights</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">]</span>

            <span class="c"># Join them to the transit vehicle trips so we can put people on vehicles</span>
            <span class="n">veh_loaded_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>   <span class="o">=</span><span class="n">veh_trips_df</span><span class="p">,</span>                     <span class="n">right</span>      <span class="o">=</span><span class="n">passenger_trips_boards</span><span class="p">,</span>
                                         <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">],</span> <span class="n">right_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                         <span class="n">how</span>    <span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">)</span>
            <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;path_id&#39;</span><span class="p">:</span><span class="s">&#39;boards&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="n">veh_loaded_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>   <span class="o">=</span><span class="n">veh_loaded_df</span><span class="p">,</span>                   <span class="n">right</span>      <span class="o">=</span><span class="n">passenger_trips_alights</span><span class="p">,</span>
                                        <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">],</span> <span class="n">right_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                        <span class="n">how</span>    <span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">)</span>
            <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;path_id&#39;</span><span class="p">:</span><span class="s">&#39;alights&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">veh_loaded_df</span><span class="p">)</span><span class="o">==</span><span class="n">veh_trips_df_len</span><span class="p">)</span>

            <span class="c"># these are ints, not floats</span>
            <span class="n">veh_loaded_df</span><span class="p">[[</span><span class="s">&#39;boards&#39;</span><span class="p">,</span><span class="s">&#39;alights&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="p">[[</span><span class="s">&#39;boards&#39;</span><span class="p">,</span><span class="s">&#39;alights&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">veh_loaded_df</span><span class="p">[</span><span class="s">&#39;onboard&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">boards</span> <span class="o">-</span> <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">alights</span>
            <span class="c"># print veh_trips_df.loc[5123368]</span>

            <span class="c"># on board is the cumulative sum of boards - alights</span>
            <span class="n">trips_cumsum</span> <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="p">[[</span><span class="s">&#39;onboard&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
            <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">&#39;onboard&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c"># replace with cumsum</span>
            <span class="n">veh_loaded_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>      <span class="o">=</span><span class="n">veh_loaded_df</span><span class="p">,</span>  <span class="n">right</span>      <span class="o">=</span><span class="n">trips_cumsum</span><span class="p">,</span>
                                         <span class="n">left_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>          <span class="n">right_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                         <span class="n">how</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">veh_loaded_df</span><span class="p">)</span><span class="o">==</span><span class="n">veh_trips_df_len</span><span class="p">)</span>
            <span class="c"># print veh_trips_df.loc[5123368]</span>
            <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">CAPACITY_CONSTRAINT</span><span class="p">:</span>
                <span class="c"># No need to loop</span>
                <span class="k">break</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c">######################################################################################################</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Step 3. Capacity constraints on transit vehicles.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bump_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;        Bumping one at a time? </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;true&quot;</span> <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_ONE_AT_A_TIME</span> <span class="k">else</span> <span class="s">&quot;false&quot;</span><span class="p">))</span>
                <span class="c"># This needs to run at this point because the arrival times for the passengers are accurate here</span>

                <span class="c"># Who gets bumped?</span>
                <span class="c"># overcap = how many people are problematic</span>
                <span class="n">veh_loaded_df</span><span class="p">[</span><span class="s">&#39;overcap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">onboard</span> <span class="o">-</span> <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">capacity</span>
                <span class="n">overcap_df</span>     <span class="o">=</span> <span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">veh_loaded_df</span><span class="o">.</span><span class="n">overcap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> vehicle trip/stops over capacity: (showing head)</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                                      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">overcap_df</span><span class="p">),</span>
                                      <span class="n">overcap_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">formatters</span><span class="o">=</span>\
                   <span class="p">{</span><span class="s">&#39;arrive_time&#39;</span>  <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">,</span>
                    <span class="s">&#39;depart_time&#39;</span>  <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">})))</span>

                <span class="c"># If none, we&#39;re done</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overcap_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;        No overcapacity vehicles&quot;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="c"># start by bumping the first ones who board after at capacity - which stops are they?</span>
                <span class="n">bump_stops_df</span>  <span class="o">=</span> <span class="n">overcap_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">&#39;trip_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="s">&#39;first&#39;</span><span class="p">)</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Bump stops (</span><span class="si">%d</span><span class="s"> rows, showing head):</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bump_stops_df</span><span class="p">),</span>
                                      <span class="n">bump_stops_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">formatters</span><span class="o">=</span>\
                   <span class="p">{</span><span class="s">&#39;arrive_time&#39;</span>  <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">,</span>
                    <span class="s">&#39;depart_time&#39;</span>  <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">})))</span>

                <span class="c"># One stop at a time -- slower but more accurate</span>
                <span class="k">if</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">BUMP_ONE_AT_A_TIME</span><span class="p">:</span>
                    <span class="n">bump_stops_df</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s">&#39;arrive_time&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">bump_stops_df</span> <span class="o">=</span> <span class="n">bump_stops_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;        Need to bump </span><span class="si">%d</span><span class="s"> passengers from </span><span class="si">%d</span><span class="s"> stops&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bump_stops_df</span><span class="o">.</span><span class="n">overcap</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bump_stops_df</span><span class="p">)))</span>

                <span class="c"># who boards at those stops?</span>
                <span class="n">bumped_pax_boards</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>    <span class="o">=</span><span class="n">passenger_trips</span><span class="p">[[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;A_id&#39;</span><span class="p">,</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">,</span><span class="s">&#39;A_seq&#39;</span><span class="p">,</span><span class="s">&#39;A_time&#39;</span><span class="p">]],</span>
                                                 <span class="n">left_on</span> <span class="o">=</span><span class="p">[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;A_id&#39;</span><span class="p">,</span><span class="s">&#39;A_seq&#39;</span><span class="p">],</span>
                                                 <span class="n">right</span>   <span class="o">=</span><span class="n">bump_stops_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">,</span><span class="s">&#39;arrive_time&#39;</span><span class="p">,</span><span class="s">&#39;depart_time&#39;</span><span class="p">,</span><span class="s">&#39;overcap&#39;</span><span class="p">]],</span>
                                                 <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">],</span>
                                                 <span class="n">how</span>     <span class="o">=</span><span class="s">&#39;inner&#39;</span><span class="p">)</span>
                <span class="c"># bump off later arrivals, later path_id</span>
                <span class="n">bumped_pax_boards</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s">&#39;arrive_time&#39;</span><span class="p">,</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">,</span><span class="s">&#39;stop_id&#39;</span><span class="p">,</span><span class="s">&#39;A_time&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">],</span>
                                       <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">bumped_pax_boards</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                <span class="c"># For each trip_id, stop_seq, stop_id, we want the first *overcap* rows</span>
                <span class="c"># group to trip_id, stop_seq, stop_id and count off</span>
                <span class="n">bpb_count</span> <span class="o">=</span> <span class="n">bumped_pax_boards</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">,</span><span class="s">&#39;stop_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span>
                <span class="n">bpb_count</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;bump_index&#39;</span>

                <span class="c"># Add the bump index to our passenger-paths/stops</span>
                <span class="n">bumped_pax_boards</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bumped_pax_boards</span><span class="p">,</span> <span class="n">bpb_count</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;bumped_pax_boards (</span><span class="si">%d</span><span class="s"> rows, showing head):</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bumped_pax_boards</span><span class="p">),</span>
                    <span class="n">bumped_pax_boards</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">formatters</span><span class="o">=</span>\
                   <span class="p">{</span><span class="s">&#39;A_time&#39;</span>       <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">,</span>
                    <span class="s">&#39;arrive_time&#39;</span>  <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">,</span>
                    <span class="s">&#39;depart_time&#39;</span>  <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">})))</span>

                <span class="c"># use it to filter to those we bump</span>
                <span class="n">bumped_pax_boards</span> <span class="o">=</span> <span class="n">bumped_pax_boards</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bumped_pax_boards</span><span class="o">.</span><span class="n">bump_index</span> <span class="o">&lt;</span> <span class="n">bumped_pax_boards</span><span class="o">.</span><span class="n">overcap</span><span class="p">]</span>

                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;filtered bumped_pax_boards (</span><span class="si">%d</span><span class="s"> rows, showing head):</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bumped_pax_boards</span><span class="p">),</span>
                    <span class="n">bumped_pax_boards</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">formatters</span><span class="o">=</span>\
                   <span class="p">{</span><span class="s">&#39;A_time&#39;</span>       <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">,</span>
                    <span class="s">&#39;arrive_time&#39;</span>  <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">,</span>
                    <span class="s">&#39;depart_time&#39;</span>  <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">})))</span>

                <span class="c"># filter to unique passengers/paths</span>
                <span class="n">bumped_pax_boards</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">bumped_pax_boards</span><span class="p">[</span><span class="s">&#39;bump&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

                <span class="c"># keep track of these</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">bumped_passenger_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bumped_pax_boards</span><span class="o">.</span><span class="n">passenger_id</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">bumped_path_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bumped_pax_boards</span><span class="o">.</span><span class="n">passenger_id</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;bumped_pax_boards without duplicate passengers (</span><span class="si">%d</span><span class="s"> rows, showing head):</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bumped_pax_boards</span><span class="p">),</span>
                     <span class="n">bumped_pax_boards</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">formatters</span><span class="o">=</span>\
                   <span class="p">{</span><span class="s">&#39;A_time&#39;</span>       <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">,</span>
                    <span class="s">&#39;arrive_time&#39;</span>  <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">,</span>
                    <span class="s">&#39;depart_time&#39;</span>  <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">})))</span>

                <span class="c"># Kick out the bumped passengers</span>
                <span class="n">passengers_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span>     <span class="o">=</span><span class="n">passengers_df</span><span class="p">,</span>
                                             <span class="n">right</span>    <span class="o">=</span><span class="n">bumped_pax_boards</span><span class="p">[[</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">,</span><span class="s">&#39;bump&#39;</span><span class="p">]],</span>
                                             <span class="n">left_on</span>  <span class="o">=</span><span class="p">[</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">],</span>
                                             <span class="n">right_on</span> <span class="o">=</span><span class="p">[</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">],</span>
                                             <span class="n">how</span>      <span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">)</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">passengers_df_len</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">passengers_df</span><span class="p">))</span>
                <span class="n">passengers_df</span> <span class="o">=</span> <span class="n">passengers_df</span><span class="p">[</span><span class="n">passengers_df</span><span class="o">.</span><span class="n">bump</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">]</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;        Bumped </span><span class="si">%d</span><span class="s"> passengers; passenger_df length </span><span class="si">%d</span><span class="s"> -&gt; </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bumped_pax_boards</span><span class="p">),</span> <span class="n">passengers_df_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">passengers_df</span><span class="p">)))</span>
                <span class="n">passengers_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">&#39;bump&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">passengers_df_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">passengers_df</span><span class="p">)</span>

                <span class="c"># recreate</span>
                <span class="n">passenger_trips</span> <span class="o">=</span> <span class="n">passengers_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">passengers_df</span><span class="o">.</span><span class="n">linkmode</span><span class="o">==</span><span class="s">&#39;Trip&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">passenger_trips_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">passenger_trips</span><span class="p">)</span>

                <span class="n">new_bump_wait</span> <span class="o">=</span> <span class="n">bumped_pax_boards</span><span class="p">[[</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;A_id&#39;</span><span class="p">,</span><span class="s">&#39;A_seq&#39;</span><span class="p">,</span><span class="s">&#39;A_time&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;A_id&#39;</span><span class="p">,</span><span class="s">&#39;A_seq&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">new_bump_wait</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">new_bump_wait</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;A_id&#39;</span><span class="p">:</span><span class="s">&#39;stop_id&#39;</span><span class="p">,</span><span class="s">&#39;A_seq&#39;</span><span class="p">:</span><span class="s">&#39;stop_seq&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;new_bump_wait (</span><span class="si">%d</span><span class="s"> rows, showing head):</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_bump_wait</span><span class="p">),</span> <span class="n">new_bump_wait</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">formatters</span><span class="o">=</span>\
                   <span class="p">{</span><span class="s">&#39;A_time&#39;</span>       <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">})))</span>

                <span class="c"># incorporate it into the bump wait df</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="bp">None</span><span class="p">):</span>
                    <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span> <span class="o">=</span> <span class="n">new_bump_wait</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_bump_wait</span><span class="p">)</span>
                    <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">([</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                <span class="c"># incorporate it into the bump wait</span>
                <span class="c"># This is (trip_id, stop_id) -&gt; Timestamp</span>
                <span class="n">bump_wait_dict</span>  <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s">&#39;trip_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_id&#39;</span><span class="p">,</span><span class="s">&#39;stop_seq&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s">&#39;A_time&#39;</span><span class="p">]</span>
                <span class="n">bump_wait_dict2</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bump_wait_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()}</span>
                <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bump_wait_dict2</span><span class="p">)</span>

                <span class="c"># FastTripsLogger.debug(&quot;Bump wait ---------&quot;)</span>
                <span class="c"># for key,val in Assignment.bump_wait.iteritems():</span>
                <span class="c">#     FastTripsLogger.debug(&quot;(%10s, %10s, %10s) -&gt; %s&quot; %</span>
                <span class="c">#                           (str(key[0]), str(key[1]), str(key[2]), val.strftime(&quot;%H:%M:%S&quot;)))</span>

                <span class="n">bump_iter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;        -&gt; complete loop iter </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">bump_iter</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">==</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">[</span><span class="s">&#39;A_time_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">[</span><span class="s">&#39;A_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mf">60.0</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">minute</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">second</span><span class="o">/</span><span class="mf">60.0</span><span class="p">))</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Bumped passenger ids: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bumped_passenger_ids</span><span class="p">))</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Bumped path ids: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bumped_path_ids</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">==</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Bump_wait_df:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">bump_wait_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">formatters</span><span class="o">=</span>\
                <span class="p">{</span><span class="s">&#39;A_time&#39;</span>       <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_formatter</span><span class="p">}))</span>

        <span class="c">######################################################################################################</span>
        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Step 4. Convert times to strings (minutes past midnight) for joining&quot;</span><span class="p">)</span>

        <span class="c">######         TODO: this is really catering to output format; an alternative might be more appropriate</span>
        <span class="n">passenger_trips</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span>  <span class="s">&#39;board_time_str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">passenger_trips</span><span class="o">.</span><span class="n">board_time</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">)</span>
        <span class="n">passenger_trips</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s">&#39;arrival_time_str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">passenger_trips</span><span class="o">.</span><span class="n">arrival_time</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">)</span>
        <span class="n">passenger_trips</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s">&#39;alight_time_str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">passenger_trips</span><span class="o">.</span><span class="n">alight_time</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">passenger_trips</span><span class="p">)</span> <span class="o">==</span> <span class="n">passenger_trips_len</span><span class="p">)</span>

        <span class="c"># Aggregate (by joining) across each passenger + path</span>
        <span class="n">ptrip_group</span> <span class="o">=</span> <span class="n">passenger_trips</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">])</span>
        <span class="c"># these are Series</span>
        <span class="n">board_time_str</span>   <span class="o">=</span> <span class="n">ptrip_group</span><span class="p">[</span><span class="s">&#39;board_time_str&#39;</span>  <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">arrival_time_str</span> <span class="o">=</span> <span class="n">ptrip_group</span><span class="p">[</span><span class="s">&#39;arrival_time_str&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">alight_time_str</span>  <span class="o">=</span> <span class="n">ptrip_group</span><span class="p">[</span><span class="s">&#39;alight_time_str&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="c"># Aggregate other fields across each passenger + path</span>
        <span class="n">pax_exp_df</span> <span class="o">=</span> <span class="n">passengers_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">&#39;passenger_id&#39;</span><span class="p">,</span><span class="s">&#39;path_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="p">{</span><span class="s">&#39;pathmode&#39;</span>     <span class="p">:</span><span class="s">&#39;first&#39;</span><span class="p">,</span>  <span class="c"># path mode</span>
             <span class="s">&#39;A_id&#39;</span>         <span class="p">:</span><span class="s">&#39;first&#39;</span><span class="p">,</span>  <span class="c"># origin</span>
             <span class="s">&#39;B_id&#39;</span>         <span class="p">:</span><span class="s">&#39;last&#39;</span><span class="p">,</span>   <span class="c"># destination</span>
             <span class="s">&#39;A_time&#39;</span>       <span class="p">:</span><span class="s">&#39;first&#39;</span><span class="p">,</span>  <span class="c"># start time</span>
             <span class="s">&#39;B_time&#39;</span>       <span class="p">:</span><span class="s">&#39;last&#39;</span><span class="p">,</span>   <span class="c"># end time</span>
             <span class="s">&#39;cost&#39;</span>         <span class="p">:</span><span class="s">&#39;first&#39;</span><span class="p">,</span>  <span class="c"># total travel cost is calculated for the whole path</span>
            <span class="p">})</span>

        <span class="c"># Put them together and return</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pax_exp_df</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">board_time_str</span><span class="p">))</span>
        <span class="n">pax_exp_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pax_exp_df</span><span class="p">,</span>
                                    <span class="n">board_time_str</span><span class="p">,</span>
                                    <span class="n">arrival_time_str</span><span class="p">,</span>
                                    <span class="n">alight_time_str</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># print pax_exp_df.to_string(formatters={&#39;A_time&#39;:Assignment.datetime64_min_formatter,</span>
        <span class="c">#                                        &#39;B_time&#39;:Assignment.datetime64_min_formatter})</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">TRACE_PASSENGER_IDS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">simulated_passenger_ids</span> <span class="o">=</span> <span class="n">passengers_df</span><span class="o">.</span><span class="n">passenger_id</span><span class="o">.</span><span class="n">values</span>

        <span class="k">for</span> <span class="n">trace_pax</span> <span class="ow">in</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">TRACE_PASSENGER_IDS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace_pax</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">simulated_passenger_ids</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Passenger </span><span class="si">%d</span><span class="s"> not in final simulated list&quot;</span> <span class="o">%</span> <span class="n">trace_pax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Final passengers_df for </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                   <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">trace_pax</span><span class="p">),</span>
                    <span class="n">passengers_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">passengers_df</span><span class="o">.</span><span class="n">passenger_id</span><span class="o">==</span><span class="n">trace_pax</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">formatters</span><span class="o">=</span>\
                   <span class="p">{</span><span class="s">&#39;A_time&#39;</span>               <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">,</span>
                    <span class="s">&#39;B_time&#39;</span>               <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">,</span>
                    <span class="s">&#39;linktime&#39;</span>             <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">timedelta_formatter</span><span class="p">,</span>
                    <span class="s">&#39;board_time&#39;</span>           <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">,</span>
                    <span class="s">&#39;alight_time&#39;</span>          <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">,</span>
                    <span class="s">&#39;board_time_prev&#39;</span>      <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">,</span>
                    <span class="s">&#39;alight_time_prev&#39;</span>     <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">,</span>
                    <span class="s">&#39;B_time_prev&#39;</span>          <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">,</span>
                    <span class="s">&#39;A_time_next&#39;</span>          <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">,})))</span>

                <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Passengers experienced times for </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                   <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">trace_pax</span><span class="p">),</span>
                    <span class="n">pax_exp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trace_pax</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">formatters</span><span class="o">=</span>\
                   <span class="p">{</span><span class="s">&#39;A_time&#39;</span>               <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">,</span>
                    <span class="s">&#39;B_time&#39;</span>               <span class="p">:</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">})))</span>

        <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pax_exp_df</span><span class="p">),</span> <span class="n">veh_loaded_df</span><span class="p">,</span> <span class="n">pax_exp_df</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Assignment.print_load_profile"><a class="viewcode-back" href="../../_generated/fasttrips.Assignment.html#fasttrips.Assignment.print_load_profile">[docs]</a>    <span class="k">def</span> <span class="nf">print_load_profile</span><span class="p">(</span><span class="n">veh_trips_df</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the load profile output</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># reset columns</span>
        <span class="n">print_veh_trips_df</span> <span class="o">=</span> <span class="n">veh_trips_df</span>

        <span class="n">Trip</span><span class="o">.</span><span class="n">calculate_dwell_times</span><span class="p">(</span><span class="n">print_veh_trips_df</span><span class="p">)</span>
        <span class="n">print_veh_trips_df</span> <span class="o">=</span> <span class="n">Trip</span><span class="o">.</span><span class="n">calculate_headways</span><span class="p">(</span><span class="n">print_veh_trips_df</span><span class="p">)</span>

        <span class="c"># rename columns</span>
        <span class="n">print_veh_trips_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span>
           <span class="p">{</span><span class="s">&#39;trip_id&#39;</span>        <span class="p">:</span><span class="s">&#39;tripId&#39;</span><span class="p">,</span>
            <span class="s">&#39;stop_id&#39;</span>        <span class="p">:</span><span class="s">&#39;stopId&#39;</span><span class="p">,</span>
            <span class="s">&#39;dwell_time&#39;</span>     <span class="p">:</span><span class="s">&#39;dwellTime&#39;</span><span class="p">,</span>
            <span class="s">&#39;boards&#39;</span>         <span class="p">:</span><span class="s">&#39;boardings&#39;</span><span class="p">,</span>
            <span class="s">&#39;alights&#39;</span>        <span class="p">:</span><span class="s">&#39;alightings&#39;</span><span class="p">,</span>
            <span class="s">&#39;onboard&#39;</span>        <span class="p">:</span><span class="s">&#39;load&#39;</span>
            <span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># recode/reformat</span>
        <span class="n">print_veh_trips_df</span><span class="p">[</span><span class="s">&#39;traveledDist&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">print_veh_trips_df</span><span class="p">[</span><span class="s">&#39;departureTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">print_veh_trips_df</span><span class="o">.</span><span class="n">depart_time</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">datetime64_min_formatter</span><span class="p">)</span>
        <span class="c"># reorder</span>
        <span class="n">print_veh_trips_df</span> <span class="o">=</span> <span class="n">print_veh_trips_df</span><span class="p">[[</span><span class="s">&#39;routeId&#39;</span><span class="p">,</span><span class="s">&#39;shapeId&#39;</span><span class="p">,</span><span class="s">&#39;tripId&#39;</span><span class="p">,</span><span class="s">&#39;direction&#39;</span><span class="p">,</span><span class="s">&#39;stopId&#39;</span><span class="p">,</span>
                                         <span class="s">&#39;traveledDist&#39;</span><span class="p">,</span><span class="s">&#39;departureTime&#39;</span><span class="p">,</span><span class="s">&#39;headway&#39;</span><span class="p">,</span><span class="s">&#39;dwellTime&#39;</span><span class="p">,</span>
                                         <span class="s">&#39;boardings&#39;</span><span class="p">,</span><span class="s">&#39;alightings&#39;</span><span class="p">,</span><span class="s">&#39;load&#39;</span><span class="p">]]</span>

        <span class="n">load_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">&quot;ft_output_loadProfile.dat&quot;</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">print_veh_trips_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">load_file</span><span class="p">,</span>
                              <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span>
                              <span class="n">float_format</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span><span class="p">,</span>
                              <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">load_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div></div>
<span class="k">def</span> <span class="nf">find_trip_based_paths_process_worker</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">worker_num</span><span class="p">,</span> <span class="n">input_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">todo_path_queue</span><span class="p">,</span> <span class="n">done_queue</span><span class="p">,</span> <span class="n">hyperpath</span><span class="p">,</span> <span class="n">bump_wait_df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process worker function.  Processes all the paths in queue.</span>

<span class="sd">    todo_queue has (passenger_id, path object)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">worker_str</span> <span class="o">=</span> <span class="s">&quot;_worker</span><span class="si">%02d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">worker_num</span>

    <span class="c"># Setup a new FT instance for this worker.</span>
    <span class="c"># This is just for reading input files into the FT structures,</span>
    <span class="c"># but it won&#39;t change the FT structures themselves (so it&#39;s a read-only instance).</span>
    <span class="c">#</span>
    <span class="c"># You&#39;d think we could have just passed the FT structure to this method but that would involve pickling/unpickling the</span>
    <span class="c"># data and ends up meaning it takes a *really long time* to start the new process ~ 2 minutes per process.</span>
    <span class="c"># Simply reading the input files again is faster.  No need to read the demand tho.</span>
    <span class="kn">from</span> <span class="nn">.FastTrips</span> <span class="kn">import</span> <span class="n">FastTrips</span>
    <span class="n">worker_FT</span> <span class="o">=</span> <span class="n">FastTrips</span><span class="p">(</span><span class="n">input_dir</span><span class="o">=</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">read_demand</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                          <span class="n">log_to_console</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">logname_append</span><span class="o">=</span><span class="n">worker_str</span><span class="p">,</span> <span class="n">appendLog</span><span class="o">=</span><span class="bp">True</span> <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">False</span><span class="p">)</span>

    <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Iteration </span><span class="si">%d</span><span class="s"> Worker </span><span class="si">%2d</span><span class="s"> starting&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">worker_num</span><span class="p">))</span>

    <span class="n">Assignment</span><span class="o">.</span><span class="n">initialize_fasttrips_extension</span><span class="p">(</span><span class="n">worker_num</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">worker_FT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Assignment</span><span class="o">.</span><span class="n">set_fasttrips_bump_wait</span><span class="p">(</span><span class="n">bump_wait_df</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c"># go through my queue -- check if we&#39;re done</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="n">todo_path_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">todo</span> <span class="o">==</span> <span class="s">&#39;DONE&#39;</span><span class="p">:</span>
            <span class="n">done_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;DONE&#39;</span><span class="p">)</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Received DONE from the todo_path_queue&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># do the work</span>
        <span class="n">passenger</span>       <span class="o">=</span> <span class="n">todo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">path</span>            <span class="o">=</span> <span class="n">todo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Processing passenger </span><span class="si">%s</span><span class="s"> path </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">passenger</span><span class="o">.</span><span class="n">passenger_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">path_id</span><span class="p">)))</span>

        <span class="n">trace_passenger</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">passenger</span><span class="o">.</span><span class="n">passenger_id</span> <span class="ow">in</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">TRACE_PASSENGER_IDS</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Tracing assignment of passenger </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">passenger</span><span class="o">.</span><span class="n">passenger_id</span><span class="p">))</span>
            <span class="n">trace_passenger</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">return_states</span><span class="p">)</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">find_trip_based_path</span><span class="p">(</span><span class="n">worker_FT</span><span class="p">,</span> <span class="n">passenger</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">hyperpath</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="n">trace_passenger</span><span class="p">)</span>
            <span class="n">done_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">(</span><span class="n">passenger</span><span class="o">.</span><span class="n">passenger_id</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">path_id</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">return_states</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">FastTripsLogger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;Exception&#39;</span><span class="p">)</span>
            <span class="c"># call it a day</span>
            <span class="n">done_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;DONE&#39;</span><span class="p">)</span>
            <span class="k">return</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Lisa Zorn.
    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>